<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Car Advertiser</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/popper")
    @Scripts.Render("~/bundles/bootstrap")
    <link href="@Url.Content("~/Content/Personal.css")" rel="stylesheet" type="text/css" />

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href='https://fonts.googleapis.com/css?family=Kaushan+Script' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700' rel='stylesheet' type='text/css'>
    <link href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/responsive/2.1.1/css/responsive.bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>

    <!--reference the autogenerated SignalR hub script-->
    <script src="~/signalr/hubs"></script>

    <script type="text/javascript">
        var replyToId;

        $(function () {

            var hub = $.connection.carAdvertiserHub;

            //declaring a function on the hub so the server can invoke it
            hub.client.displayMessage = function() {
                getData();
            };

            //Start the connection
            $.connection.hub.start();
            getData();
        });

        function getData() {
            $.ajax({
                url: '@Url.Action("GetAllUnreadMessages", "Message")',
                type: 'GET',
                datatype: 'json',
                success: function(result) {

                    var data = $.parseJSON(result);
                    if (data.length > 0) {
                        $("#msgCnt").text(data.length);
                        $("#msgCnt2").text(data.length);
                    }
                },
                error: function(result) {
                    console.log("ERROR");
                    console.log(result);
                }
            });

            var divNotification = $("#divNotification");

            $.ajax({
                url: '@Url.Action("GetAllUndeletedMessages", "Message")',
                type: 'GET',
                datatype: 'json',
                success: function(result) {

                    var data = $.parseJSON(result);

                    if (data.length > 0) {
                        divNotification.empty();

                        for (var i = 0; i < data.length; i++) {
                            var id = data[i].MessageId;
                            var message =
                                '<div class="alert alert-success alert-dismissable openDiv" id="open' + id + '"><a id="' + id + '" href="#" class="close close-click" data-dismiss="alert" aria-label="close">&times;</a>SENDER: ' + data[i].SenderName + ' | RECEIVED ON: ' + data[i].ReceivedDate + '</div>' +
                                    '<div class="alert alert-success alert-dismissable closeDiv hide" id="clos' + id + '"><a id="' + id + '" href="#" class="close close-click" data-dismiss="alert" aria-label="close">&times;</a>SENDER: ' + data[i].SenderName + ' | RECEIVED ON: ' + data[i].ReceivedDate + '</div>' +
                                    '<div class="messageDiv hide" id="mesg' + id + '">MESSAGE: ' + data[i].Message + '<i id="' + id + '" class="fas fa-reply float-right message-reply-icon" data-toggle="modal" data-target="#replyModal" data-id="' + data[i].SenderId + '"></i></div>';

                            divNotification.append(message);
                        }

                        $('.message-reply-icon').on('click', function () {
                            replyToId = $(this).data('id');
                        });

                        $(".close-click").click(function(event) {
                            var messageId = $(this).attr("id");
                            var id = event.target.id;
                            deleteMessage(messageId);
                        });

                        $(".openDiv").click(function (event) {
                            var id = event.target.id;
                            var component = id.substring(0, 4);
                            var componentId = id.substr(4);
                            if ($('#mesg'+componentId+':visible').length === 0) {
                                $('#mesg' + componentId).fadeIn('slow');
                                $('#open' + componentId).hide();
                                $('#clos' + componentId).show();
                            }
                        });

                        $(".closeDiv").click(function (event) {
                            var id = event.target.id;
                            var component = id.substring(0, 4);
                            var componentId = id.substr(4);

                            if ($('#mesg' + componentId +':visible').length !== 0) {
                                $('#mesg' + componentId).hide();
                                $('#open' + componentId).show();
                                $('#clos' + componentId).hide();
                            }
                        });


                    }
                },
                error: function(result) {
                    console.log("ERROR");
                    console.log(result);
                }
            });
        }

        function deleteMessage(messageId) {
            $.ajax({
                url: '@Url.Action("DeleteMessage", "Message")',
                type: 'POST',
                datatype: 'json',
                data: { messageId: messageId },
                success: function(result) {
                    console.log("Message " + messageId + " deleted");
                },
                error: function(result) {
                    console.log("ERROR");
                    console.log(result);
                }
            });
        }

    </script>

</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top">
        @Html.ActionLink("Car Advertiser", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="#navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto text-uppercase">
                <li class="nav-link">@Html.ActionLink("Advanced Search", "AdvertSearch", "Advert")</li>
                <li class="nav-link">@Html.ActionLink("Wanted Car", "AddWantedCar", "Advert")</li>
                @if (User.Identity.IsAuthenticated && !User.IsInRole("Admin"))
                {
                    <li class="nav-link">@Html.ActionLink("User Panel", "UserPanel", "User")</li>
                }
                @if (User.IsInRole("Admin"))
                {
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Admin
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            @if (User.IsInRole("Admin"))
                            {
                                <a class="dropdown-item" href="">Role management</a>
                                <a class="dropdown-item" href="@Url.Action("AdminPanel", "Admin")">Admin Panel</a>
                                <hr />
                                <a class="dropdown-item" href="@Url.Action("InitializeDatabase", "Database")">Initialize Database</a>
                                <a class="dropdown-item" href="@Url.Action("Purge", "Database")">Purge Database</a>
                            }
                        </div>
                    </li>
                }
                @if (User.Identity.IsAuthenticated)
                {
                    <li class="nav-link">
                        @Html.ActionLink("My messages", "Index", "Message")
                        <i class="fa fa-envelope fa-1x fa-border badge" id="msgCnt2"></i>
                    </li>
                }
            </ul>
            @Html.Partial("_LoginPartial")
        </div>
    </nav>
    <div class="container-fluid body-content">
        @RenderBody()
    </div>

    <div class="push"></div>

    <footer>
        <p>&copy; @DateTime.Now.Year - Car Advertiser | All rights reserved | Created by Marcin Sorokosz </p>
    </footer>

    @RenderSection("scripts", required: false)
</body>
</html>
